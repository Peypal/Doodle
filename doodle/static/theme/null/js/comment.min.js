$(function(){var s,r,l,n=$(window),i=!1,m=!0,a=0,d=$("#commentlist>ol"),p=$("<ol/>"),o=$('<ol class="commentlist comment-float-list"/>').appendTo(document.body).hide(),u=1,t=!0,e=$("#comment-order-asc"),c=$("#comment-order-desc"),f=home_path+"article/"+article_id+"/comments/",h="undefined"!=typeof ban_url,b=$('<span id="ban-button" class="comment-action-button">确认禁言</span>'),v=$('<span id="del-comment-button" class="comment-action-button">确认删除</span>'),g=$('<span id="del-user-comments-button" class="comment-action-button">确认删除</span>'),_=$("#more-hint"),y=$("#respond"),x=location.hash,k=new Date,T={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"};function j(e){return T[e]}function w(e){return e.replace(/[&<>"']/g,j)}function C(e){var t='<li><p class="comment-author"><img src="';t+=e.img,t+='?s=48&amp;d=monsterid" class="avatar" height="48" width="48"/><cite><a id="comment-id-',t+=e.id,e.url&&(t+='" href="'+w(e.url)),t+='">'+w(e.user_name)+"</a></cite>";var n=e.ua;if(n){t+='<span class="ua">';for(var a,o=0;o<n.length;++o)t+='<img src="/static/img/ua/'+(a=e.ua[o]).replace(/ /g,"-")+'.png" alt="'+a+'" title="'+a+'"/>';t+="</span>"}return t+="<br/><small><strong>"+e.time+"</strong>",h&&(t+=' <span class="ban-user comment-action">[禁言]</span> <span class="del-comment comment-action">[删除]</span> <span class="del-user-comments comment-action">[全部删除]</span>'),t+='</small></p><div class="commententry" id="commententry-'+e.id+'"><div>'+e.content+'</div></div><a class="comment-reply-link" href="#respond">回复</a></li>'}function D(e,t,n){e.find("a.comment-reply-link").click(function(){!function(e,t){if(!l)return;var n=s.val();n+="[url=#comment-id-",n+=e,n+="]@",n+=t,n+="[/url]: ",setTimeout(function(){s.focus().val(n)},100)}(t,n)}),e.find('a[href^="#comment-id-"]').hover(function(e){var t=$(this).attr("href").substr(12),n=d.find("#comment-id-"+t);n.length&&o.css({top:e.pageY,left:e.pageX+50}).append(n.parent().parent().parent().clone().find("a.comment-reply-link").remove().end()).fadeTo(1e3,.9)},function(){o.hide().empty()}),e.find("pre>code").each(function(e,t){hljs.highlightBlock(t)}),h&&(e.find("span.ban-user").data("id",t).hover(function(){$(this).append(b)},function(){b.detach()}),e.find("span.del-comment").data("id",t).hover(function(){$(this).append(v)},function(){v.detach()}),e.find("span.del-user-comments").data("id",t).hover(function(){$(this).append(g)},function(){g.detach()}))}function E(){var e=f;e+=t?"asc/":"desc/",e+=u,$.ajax({url:e,dataType:"json",error:function(e,t){"timeout"==t&&E()},success:function(e){var t=e.next_page;t?(u=t,_.show()):(i=!0,_.hide());var n=e.comments,a=n.length;if(a){for(var o=0;o<a;++o){var c=n[o];D($(C(c)).appendTo(p),c.id,c.user_name)}p.children().unwrap().hide().appendTo(d).slideDown(1e3),x&&(new Date-k<5e3&&(scroller.is_scrolling()||$(x).scrollTo()),x=null)}m=!1,ga_id&&ga("send","event","Comment","Load",null,article_id)},timeout:1e4})}hljs.configure({tabReplace:"    "}),$("pre>code").each(function(e,t){hljs.highlightBlock(t)}),$.extend({show_comment_form:function(e,t,n,a,o){if(o)y.append('<p>您需要<a href="'+o+'">登录</a>您的 Google 账号才能进行评论。</p>');else{y.append('<form action="'+t+'" method="post" id="commentform">\t<p>您当前登录的用户为：'+w(e)+'，您可<a href="'+a+'">修改用户资料</a>，或<a href="'+n+'">登出</a>以更换用户。</p>\t<p><textarea name="comment" id="comment" cols="58" rows="10" tabindex="1"></textarea></p>\t<p><input name="bbcode" type="checkbox" id="bbcode" tabindex="2" checked="checked"/> <label for="bbcode">启用BBCode</label></p>\t<p><small>小提示：回复某条回帖时，可以点击其右侧的“回复”按钮，这样该帖的作者会收到邮件通知。</small></p>\t<p><input name="submit" type="submit" id="submit" tabindex="3" value="来一发"/></p></form>'),l=!0,s=$("#comment"),r=$("#commentform"),s.markItUp(BbcodeSettings),$("#comments").find("a").click(function(){s.focus()});var c=!1,i=r.find("#bbcode");r.submit(function(){if(c)return!1;c=!0;var e=$.trim(s.val());if(!e)return $.msgbox("拜托，你也写点内容再发表吧"),c=!1;var t={comment:e};return i.attr("checked")&&(t.bbcode="on"),$.ajax({url:r.attr("action"),data:t,dataType:"json",type:"POST",error:function(e){c=!1,$.msgbox(403==e.status?"抱歉，您需要登录才能发表评论":"抱歉，遇到不明状况，发送失败了")},success:function(e){var t=e.comment,n=$(C(t));D(n,t.id,t.user_name),n.hide().appendTo(d).slideDown(1e3),s.val(""),$.msgbox("评论成功"),c=!1,ga_id&&ga("send","event","Comment","Reply",null,article_id)},timeout:1e4}),!1})}}}),e.click(function(){e.addClass("selected"),c.removeClass("selected"),t||(m=!0,d.empty(),i=!(t=!0),u=1,E())}),c.click(function(){c.addClass("selected"),e.removeClass("selected"),t&&(m=!0,d.empty(),i=t=!1,u=1,E())}),x?c.click():E(),_.find("a").click(function(){i=!0,_.hide()}),h&&(b.click(function(){var e=b.parent();e.parent().parent().parent();$.ajax({url:ban_url+e.data("id"),dataType:"json",type:"POST",error:function(){msgbbox("遇到不明状况，禁言失败了")},success:function(e){b.detach()},timeout:1e4})}),v.click(function(){var e=v.parent(),t=e.parent().parent().parent();$.ajax({url:delete_comment_url+e.data("id"),dataType:"json",type:"DELETE",error:function(){msgbbox("遇到不明状况，评论删除失败了")},success:function(e){t.slideUp("2000",function(){v.detach(),t.remove()})},timeout:1e4})}),g.click(function(){var e=g.parent(),t=e.parent().parent().parent();$.ajax({url:delete_user_comments_url+e.data("id"),dataType:"json",type:"DELETE",error:function(){msgbbox("遇到不明状况，评论删除失败了")},success:function(e){t.slideUp("2000",function(){v.detach(),t.remove()})},timeout:1e4})})),n.scroll(function(e){var t=n.scrollTop();!i&&!m&&!scroller.is_scrolling()&&a<t&&20<n.scrollTop()+n.height()-y.offset().top-y.outerHeight()&&(m=!0,E()),a=t,scroller.is_stopping()&&scroller.set_stopped()})});